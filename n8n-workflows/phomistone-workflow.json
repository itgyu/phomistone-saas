{
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "style-building",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "66528b17-0ff1-4fab-a2ac-7855cbfdccdb",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        416,
        240
      ],
      "webhookId": "2d65bf7d-1462-4929-90c8-bc0c5f985f21"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://host.docker.internal:3001/prompt",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ \n  {\n    \"material_id\": $('Webhook').item.json.body.material_id \n  } \n}}",
        "options": {}
      },
      "id": "6eabb4d0-afc1-4154-8e69-18ea80c1bc4e",
      "name": "Get Material from MCP",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        624,
        240
      ]
    },
    {
      "parameters": {
        "jsCode": "// 1. ì´ë¯¸ì§€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (Webhook ì—°ê²° í™•ì¸)\nconst webhookData = $('Webhook').item.json.body;\nconst cleanImage = webhookData.image_base64.replace(/^data:image\\/\\w+;base64,/, \"\");\n\n// 2. ìì¬ ì •ë³´ ê°€ì ¸ì˜¤ê¸°\nconst mcp = $('Get Material from MCP').item.json;\n\n// 3. API í‚¤ ì„¤ì • (ì—¬ê¸°ì— ìƒˆ í‚¤ë¥¼ ë„£ìœ¼ì„¸ìš”!)\nconst googleApiKey = \"AIzaSyBCaCH-PvGolVKDJYBANYJS9dUXrZI59sE\";\n\n// 4. Brain(ë¶„ì„ê°€)ì—ê²Œ ë³´ë‚¼ ë°ì´í„° í¬ì¥\nconst analystPayload = {\n  contents: [{\n    parts: [\n      { text: \"ROLE: Architectural Analyst.\\nTASK: Analyze building geometry, windows, lighting. Output description only.\" },\n      { inline_data: { mime_type: \"image/jpeg\", data: cleanImage } }\n    ]\n  }],\n  generationConfig: { temperature: 0.2 }\n};\n\n// 5. ë‹¤ìŒ ë‹¨ê³„ë¡œ ëª¨ë“  ì¬ë£Œ ë„˜ê¸°ê¸°\nreturn [{\n  json: {\n    analystPayload: analystPayload,\n    cleanImage: cleanImage,\n    mcp: mcp,\n    googleApiKey: googleApiKey // í‚¤ ì „ë‹¬\n  }\n}];"
      },
      "id": "5fe81b7b-4ad9-4ff4-ab44-024f02883161",
      "name": "Prep for Brain",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        816,
        240
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-preview:generateContent?key=AIzaSyBCaCH-PvGolVKDJYBANYJS9dUXrZI59sE",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{\n{\n  \"contents\": [{\n    \"parts\": [\n      { \"text\": \"ROLE: Architectural Analyst.\\nTASK: Analyze building geometry, windows, lighting. Output description only.\" },\n      { \"inline_data\": { \"mime_type\": \"image/jpeg\", \"data\": $json.cleanImage } }\n    ]\n  }],\n  \"generationConfig\": { \"temperature\": 0.2 }\n}\n}}",
        "options": {}
      },
      "id": "823d3620-ac61-4fe6-a914-08e7711cabdc",
      "name": "1. The Brain (Analysis)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        1024,
        240
      ]
    },
    {
      "parameters": {
        "jsCode": "// 1. ì• ë‹¨ê³„(Analyst) ë¶„ì„ ê²°ê³¼ ê°€ì ¸ì˜¤ê¸°\nconst candidates = items[0].json.candidates;\nlet analysisText = \"Modern architectural structure with clear geometry.\";\n\nif (candidates && candidates[0]?.content?.parts?.[0]?.text) {\n  analysisText = candidates[0].content.parts[0].text;\n}\n\n// 2. ìì¬ ì •ë³´ ê°€ì ¸ì˜¤ê¸°\nconst mcp = $('Get Material from MCP').item.json;\n\n// 3. ğŸš¨ [í•µì‹¬] ìì¬ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸° (Webhookì—ì„œ ì§ì ‘ êº¼ë‚´ì˜´)\nconst webhookBody = $('Webhook').item.json.body;\nconst materialImage = webhookBody.material_image_base64 || \"\";\n\n// 4. Prompter(ì„¤ê³„ì)ì—ê²Œ ë³´ë‚¼ ë°ì´í„° ìƒì„±\nconst parts = [\n  { \n    text: `ROLE: Prompt Engineer.\n    \n    [INPUT ANALYSIS]:\n    ${analysisText}\n    \n    [TARGET MATERIAL]:\n    ${mcp.name} (${mcp.positive_prompt})\n    \n    [TASK]:\n    Write a concise image generation prompt to apply the target material to the analyzed structure.\n    \n    [OUTPUT]:\n    Raw prompt text only.` \n  }\n];\n\n// ìì¬ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ Prompterì—ê²Œë„ ë³´ì—¬ì¤Œ (ë” ì •í™•í•œ ë¬˜ì‚¬ë¥¼ ìœ„í•´)\nif (materialImage) {\n  parts.push({ inline_data: { mime_type: \"image/png\", data: materialImage } });\n}\n\nconst googleBody = {\n  contents: [{ parts: parts }],\n  generationConfig: { temperature: 0.7 }\n};\n\n// 5. ğŸš¨ [ìˆ˜ì •] Gemini payloadë¥¼ JSON ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ë¶„ë¦¬\nreturn [{\n  json: {\n    payload: JSON.stringify(googleBody),\n    materialImage: materialImage,\n    mcp_name: mcp.name\n  }\n}];"
      },
      "id": "e2d8af8f-2ea2-47bd-9d60-d43a687e0eb2",
      "name": "Prep for Prompter",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1216,
        240
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-preview:generateContent?key=AIzaSyBCaCH-PvGolVKDJYBANYJS9dUXrZI59sE",
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "id": "4d2ee4ae-0c0c-4200-b6aa-01cd63383699",
      "name": "2. The Prompter",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        1424,
        240
      ]
    },
    {
      "parameters": {
        "jsCode": "// 1. ë°ì´í„° ëª¨ìœ¼ê¸°\nconst fileUri = items[0].json.file.uri; // ê±´ë¬¼ ì´ë¯¸ì§€ (ì—…ë¡œë“œëœ íŒŒì¼ ID)\nconst prompt = $('2. The Prompter').item.json.candidates[0].content.parts[0].text;\nconst mcp_name = $('Get Material from MCP').item.json.name;\n\n// 2. ğŸš¨ [í•µì‹¬] ìì¬ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°\n// (Prep for Prompterì—ì„œ ë„˜ê²¨ì¤€ ê±¸ 2. The Prompterê°€ ê·¸ëŒ€ë¡œ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤)\nconst materialImage = $('Prep for Prompter').item.json.materialImage || \"\";\n\n// 3. Master(ë‚˜ë…¸ë°”ë‚˜ë‚˜í”„ë¡œ)ì—ê²Œ ë³´ë‚¼ ìµœì¢… ë°ì´í„°\nconst parts = [\n  { \n    text: `FINAL TASK: Material Replacement.\n    \n    [INSTRUCTION]:\n    ${prompt}\n    \n    [INPUTS]:\n    1. Base Structure: Provided via File URI (Do NOT change geometry)\n    2. Style Reference: Provided Inline Image (Apply this texture)\n    \n    [RULES]:\n    - Maintain Structure exactly.\n    - Apply Material Style from Reference.\n    - OUTPUT IMAGE ONLY.` \n  },\n  // ê±´ë¬¼ ì´ë¯¸ì§€ (êµ¬ì¡°ìš© - File API)\n  { file_data: { mime_type: \"image/jpeg\", file_uri: fileUri } }\n];\n\n// ìì¬ ì´ë¯¸ì§€ ì¶”ê°€ (ìŠ¤íƒ€ì¼ìš© - Inline Base64)\nif (materialImage) {\n  parts.push({ inline_data: { mime_type: \"image/png\", data: materialImage } });\n}\n\nconst masterPayload = {\n  contents: [{ parts: parts }],\n  safetySettings: [\n    { category: \"HARM_CATEGORY_HARASSMENT\", threshold: \"BLOCK_NONE\" },\n    { category: \"HARM_CATEGORY_HATE_SPEECH\", threshold: \"BLOCK_NONE\" },\n    { category: \"HARM_CATEGORY_SEXUALLY_EXPLICIT\", threshold: \"BLOCK_NONE\" },\n    { category: \"HARM_CATEGORY_DANGEROUS_CONTENT\", threshold: \"BLOCK_NONE\" }\n  ],\n  generationConfig: { temperature: 0.4 }\n};\n\nreturn [{ json: { payload: JSON.stringify(masterPayload), materialName: mcp_name } }];"
      },
      "id": "8996b98a-f5b2-4b91-9c06-86f8b108a5e7",
      "name": "Prep for Master",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        816,
        496
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent?key=AIzaSyBCaCH-PvGolVKDJYBANYJS9dUXrZI59sE",
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {
          "timeout": 600000
        }
      },
      "id": "cd4af0f3-cfc1-4c59-96b2-c2f14687c47c",
      "name": "4. The Master (NanoBanana Pro)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        1024,
        496
      ],
      "retryOnFail": true,
      "maxTries": 5,
      "waitBetweenTries": 5000
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ \n  (() => {\n    try {\n      // 1. êµ¬ê¸€ì˜ ì‘ë‹µ(ì´ë¯¸ì§€) ê°€ì ¸ì˜¤ê¸°\n      const candidate = $json.candidates?.[0];\n      const part = candidate?.content?.parts?.[0];\n      \n      // 2. ìì¬ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ ì‚¬ìš© -> ì—ëŸ¬ ë°©ì§€)\n      let matName = \"Phomistone Material\";\n      try {\n        // ì´ë¦„ì´ 'The Formatter'ì¼ ìˆ˜ë„, 'Prep for Master'ì¼ ìˆ˜ë„ ìˆìŒ\n        if ($('The Formatter')) matName = $('The Formatter').item.json.materialName;\n        else if ($('Prep for Master')) matName = $('Prep for Master').item.json.materialName;\n      } catch (e) {\n        // ì´ë¦„ ëª» ì°¾ìœ¼ë©´ ê·¸ëƒ¥ ê¸°ë³¸ê°’ ì”€\n      }\n\n      // 3. ì„±ê³µ: ì´ë¯¸ì§€ê°€ ìˆëŠ” ê²½ìš°\n      if (part?.inlineData?.data) {\n        return JSON.stringify({\n          success: true,\n          result_image_url: \"data:image/jpeg;base64,\" + part.inlineData.data,\n          material_name: matName\n        });\n      } \n      // 3-1. ì„±ê³µ (ë‹¤ë¥¸ ë³€ìˆ˜ëª… ëŒ€ì‘): snake_caseë¡œ ì˜¨ ê²½ìš°\n      else if (part?.inline_data?.data) {\n        return JSON.stringify({\n          success: true,\n          result_image_url: \"data:image/jpeg;base64,\" + part.inline_data.data,\n          material_name: matName\n        });\n      }\n      \n      // 4. ì‹¤íŒ¨: í…ìŠ¤íŠ¸ë§Œ ì˜¨ ê²½ìš°\n      return JSON.stringify({\n        success: false,\n        error: \"Model Response Text: \" + (part?.text || \"No content\"),\n        full_response: $json\n      });\n\n    } catch (e) {\n      return JSON.stringify({ success: false, error: \"Final Parsing Error: \" + e.message });\n    }\n  })()\n}}",
        "options": {}
      },
      "id": "3ebbbfca-5016-41a3-871e-d5d826bd33ab",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1216,
        496
      ]
    },
    {
      "parameters": {
        "jsCode": "// 1. Webhookì—ì„œ ì§ì ‘ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸° (ì´ë¦„ ì˜¤ë¥˜ ë°©ì§€)\nconst webhookData = $('Webhook').item.json.body;\nconst cleanImage = webhookData.image_base64.replace(/^data:image\\/\\w+;base64,/, \"\");\n\n// 2. n8n ì „ìš© 'ë°”ì´ë„ˆë¦¬ íŒŒì¼' ë§Œë“¤ê¸°\nreturn [{\n  json: {},\n  binary: {\n    data: {\n      data: cleanImage,\n      mimeType: 'image/jpeg',\n      fileName: 'upload.jpg'\n    }\n  }\n}];"
      },
      "id": "05a1ca42-79b2-4bb8-ab38-f0257b9fd110",
      "name": "Make Binary File",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        416,
        496
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/upload/v1beta/files?uploadType=media&key=AIzaSyBCaCH-PvGolVKDJYBANYJS9dUXrZI59sE",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "image/jpeg"
            }
          ]
        },
        "sendBody": true,
        "contentType": "binaryData",
        "inputDataFieldName": "data",
        "options": {}
      },
      "id": "860c853c-338d-4727-a1a5-cc8385e9b6da",
      "name": "3. Google File Uploader",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        624,
        496
      ]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Get Material from MCP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Material from MCP": {
      "main": [
        [
          {
            "node": "Prep for Brain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep for Brain": {
      "main": [
        [
          {
            "node": "1. The Brain (Analysis)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1. The Brain (Analysis)": {
      "main": [
        [
          {
            "node": "Prep for Prompter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep for Prompter": {
      "main": [
        [
          {
            "node": "2. The Prompter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "2. The Prompter": {
      "main": [
        [
          {
            "node": "Make Binary File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep for Master": {
      "main": [
        [
          {
            "node": "4. The Master (NanoBanana Pro)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "4. The Master (NanoBanana Pro)": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Make Binary File": {
      "main": [
        [
          {
            "node": "3. Google File Uploader",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3. Google File Uploader": {
      "main": [
        [
          {
            "node": "Prep for Master",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "instanceId": "9c46e96a26be114faa00aba91a37ad455fb0879f25e4c80e7358755c84a78cc4"
  }
}