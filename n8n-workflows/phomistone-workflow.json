{
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "style-building",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "324efce4-c33b-4943-97f9-9d3cd20d6cde",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        -64,
        -16
      ],
      "webhookId": "2d65bf7d-1462-4929-90c8-bc0c5f985f21"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://host.docker.internal:3001/prompt",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ \n  {\n    \"material_id\": $('Webhook').item.json.body.material_id \n  } \n}}",
        "options": {}
      },
      "id": "409b1297-1bf1-418c-8ddc-e347c379ab23",
      "name": "Get Material from MCP",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        144,
        -16
      ]
    },
    {
      "parameters": {
        "jsCode": "// 1. ì´ë¯¸ì§€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (Webhook ì—°ê²° í™•ì¸)\nconst webhookData = $('Webhook').item.json.body;\nconst cleanImage = webhookData.image_base64.replace(/^data:image\\/\\w+;base64,/, \"\");\n\n// 1-1. ğŸš¨ ì›ë³¸ ì´ë¯¸ì§€ í¬ê¸° ì¶”ì¶œ\nconst originalWidth = webhookData.original_width || 1024;\nconst originalHeight = webhookData.original_height || 1024;\n\n// 2. ìì¬ ì •ë³´ ê°€ì ¸ì˜¤ê¸°\nconst mcp = $('Get Material from MCP').item.json;\n\n// 3. API í‚¤ ì„¤ì • (ì—¬ê¸°ì— ìƒˆ í‚¤ë¥¼ ë„£ìœ¼ì„¸ìš”!)\nconst googleApiKey = \"AIzaSyBqXRPKYFBFxNDPjOXbMjgz3Ndh85u41UY\";\n\n// 4. Brain(ë¶„ì„ê°€)ì—ê²Œ ë³´ë‚¼ ë°ì´í„° í¬ì¥\nconst analystPayload = {\n  contents: [{\n    parts: [\n      { text: \"ROLE: Architectural Analyst.\\nTASK: Analyze building geometry, windows, lighting. Output description only.\" },\n      { inline_data: { mime_type: \"image/jpeg\", data: cleanImage } }\n    ]\n  }],\n  generationConfig: { temperature: 0.2 }\n};\n\n// 5. ë‹¤ìŒ ë‹¨ê³„ë¡œ ëª¨ë“  ì¬ë£Œ ë„˜ê¸°ê¸° (ì´ë¯¸ì§€ í¬ê¸° í¬í•¨)\nreturn [{\n  json: {\n    analystPayload: analystPayload,\n    cleanImage: cleanImage,\n    mcp: mcp,\n    googleApiKey: googleApiKey, // í‚¤ ì „ë‹¬\n    originalWidth: originalWidth,  // ğŸ‘ˆ ì¶”ê°€!\n    originalHeight: originalHeight  // ğŸ‘ˆ ì¶”ê°€!\n  }\n}];"
      },
      "id": "7892afca-da4d-48fd-b741-e7d3115b8fe9",
      "name": "Prep for Brain",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        336,
        -16
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-preview:generateContent?key=AIzaSyBqXRPKYFBFxNDPjOXbMjgz3Ndh85u41UY",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{\n{\n  \"contents\": [{\n    \"parts\": [\n      { \"text\": \"ROLE: Architectural Analyst.\\nTASK: Analyze building geometry, windows, lighting. Output description only.\" },\n      { \"inline_data\": { \"mime_type\": \"image/jpeg\", \"data\": $json.cleanImage } }\n    ]\n  }],\n  \"generationConfig\": { \"temperature\": 0.2 }\n}\n}}",
        "options": {}
      },
      "id": "904f1890-dd03-474a-8a6c-03cfb9a9dc60",
      "name": "1. The Brain (Analysis)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        544,
        -16
      ]
    },
    {
      "parameters": {
        "jsCode": "// 1. ì• ë‹¨ê³„(Analyst) ë¶„ì„ ê²°ê³¼ ê°€ì ¸ì˜¤ê¸°\nconst candidates = items[0].json.candidates;\nlet analysisText = \"Modern architectural structure with clear geometry.\";\n\nif (candidates && candidates[0]?.content?.parts?.[0]?.text) {\n  analysisText = candidates[0].content.parts[0].text;\n}\n\n// 2. ìì¬ ì •ë³´ ê°€ì ¸ì˜¤ê¸°\nconst mcp = $('Get Material from MCP').item.json;\n\n// 3. ğŸš¨ [í•µì‹¬] ìì¬ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸° (Webhookì—ì„œ ì§ì ‘ êº¼ë‚´ì˜´)\nconst webhookBody = $('Webhook').item.json.body;\nconst materialImage = webhookBody.material_image_base64 || \"\";\n\n// 4. Prompter(ì„¤ê³„ì)ì—ê²Œ ë³´ë‚¼ ë°ì´í„° ìƒì„±\nconst parts = [\n  { \n    text: `ROLE: Prompt Engineer.\n    \n    [INPUT ANALYSIS]:\n    ${analysisText}\n    \n    [TARGET MATERIAL]:\n    ${mcp.name} (${mcp.positive_prompt})\n    \n    [TASK]:\n    Write a concise image generation prompt to apply the target material to the analyzed structure.\n    \n    [OUTPUT]:\n    Raw prompt text only.` \n  }\n];\n\n// ìì¬ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ Prompterì—ê²Œë„ ë³´ì—¬ì¤Œ (ë” ì •í™•í•œ ë¬˜ì‚¬ë¥¼ ìœ„í•´)\nif (materialImage) {\n  parts.push({ inline_data: { mime_type: \"image/png\", data: materialImage } });\n}\n\nconst googleBody = {\n  contents: [{ parts: parts }],\n  generationConfig: { temperature: 0.7 }\n};\n\n// 5. ğŸš¨ [ìˆ˜ì •] Gemini payloadë¥¼ JSON ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ë¶„ë¦¬\nreturn [{\n  json: {\n    payload: JSON.stringify(googleBody),\n    materialImage: materialImage,\n    mcp_name: mcp.name\n  }\n}];"
      },
      "id": "2a7eaf74-300f-494c-aedc-6a7600ac99c4",
      "name": "Prep for Prompter",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        736,
        -16
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-preview:generateContent?key=AIzaSyBqXRPKYFBFxNDPjOXbMjgz3Ndh85u41UY",
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "id": "5b53b05c-4483-4b08-934b-7544c6850a3e",
      "name": "2. The Prompter",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        944,
        -16
      ]
    },
    {
      "parameters": {
        "jsCode": "// 1. ë°ì´í„° ëª¨ìœ¼ê¸°\nconst fileUri = items[0].json.file.uri; // ê±´ë¬¼ ì´ë¯¸ì§€ (ì—…ë¡œë“œëœ íŒŒì¼ ID)\nconst prompt = $('2. The Prompter').item.json.candidates[0].content.parts[0].text;\nconst mcp_name = $('Get Material from MCP').item.json.name;\n\n// 2. ğŸš¨ [í•µì‹¬] ìì¬ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°\n// (Prep for Prompterì—ì„œ ë„˜ê²¨ì¤€ ê±¸ 2. The Prompterê°€ ê·¸ëŒ€ë¡œ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤)\nconst materialImage = $('Prep for Prompter').item.json.materialImage || \"\";\n\n// 2-1. ğŸš¨ ì›ë³¸ ì´ë¯¸ì§€ í¬ê¸° ê°€ì ¸ì˜¤ê¸° (Prep for Brainì—ì„œ ì „ë‹¬ë°›ìŒ)\nconst originalWidth = $('Prep for Brain').item.json.originalWidth || 1024;\nconst originalHeight = $('Prep for Brain').item.json.originalHeight || 1024;\n\n// 3. Master(ë‚˜ë…¸ë°”ë‚˜ë‚˜í”„ë¡œ)ì—ê²Œ ë³´ë‚¼ ìµœì¢… ë°ì´í„°\nconst parts = [\n  { \n    text: `FINAL TASK: Material Replacement.\n    \n    [CRITICAL REQUIREMENT]:\n    âš ï¸ OUTPUT IMAGE MUST BE EXACTLY ${originalWidth} x ${originalHeight} PIXELS.\n    âš ï¸ DO NOT CROP, RESIZE, OR CHANGE ASPECT RATIO.\n    âš ï¸ MAINTAIN EXACT DIMENSIONS OF INPUT IMAGE: ${originalWidth}px Ã— ${originalHeight}px\n    \n    [INSTRUCTION]:\n    ${prompt}\n    \n    [INPUTS]:\n    1. Base Structure: Provided via File URI (Original size: ${originalWidth}x${originalHeight})\n    2. Style Reference: Provided Inline Image (Apply this texture)\n    \n    [RULES]:\n    - OUTPUT DIMENSIONS: ${originalWidth} Ã— ${originalHeight} pixels (EXACT MATCH REQUIRED)\n    - Maintain Structure exactly (no cropping, no resizing, no aspect ratio changes).\n    - Apply Material Style from Reference.\n    - OUTPUT IMAGE ONLY with EXACT dimensions ${originalWidth}Ã—${originalHeight}.` \n  },\n  // ê±´ë¬¼ ì´ë¯¸ì§€ (êµ¬ì¡°ìš© - File API)\n  { file_data: { mime_type: \"image/jpeg\", file_uri: fileUri } }\n];\n\n// ìì¬ ì´ë¯¸ì§€ ì¶”ê°€ (ìŠ¤íƒ€ì¼ìš© - Inline Base64)\nif (materialImage) {\n  parts.push({ inline_data: { mime_type: \"image/png\", data: materialImage } });\n}\n\nconst masterPayload = {\n  contents: [{ parts: parts }],\n  safetySettings: [\n    { category: \"HARM_CATEGORY_HARASSMENT\", threshold: \"BLOCK_NONE\" },\n    { category: \"HARM_CATEGORY_HATE_SPEECH\", threshold: \"BLOCK_NONE\" },\n    { category: \"HARM_CATEGORY_SEXUALLY_EXPLICIT\", threshold: \"BLOCK_NONE\" },\n    { category: \"HARM_CATEGORY_DANGEROUS_CONTENT\", threshold: \"BLOCK_NONE\" }\n  ],\n  generationConfig: { \n    temperature: 0.4,\n    // ğŸš¨ ì¶”ê°€: ì´ë¯¸ì§€ í¬ê¸° íŒíŠ¸\n    candidateCount: 1\n  }\n};\n\nreturn [{ json: { payload: JSON.stringify(masterPayload), materialName: mcp_name } }];"
      },
      "id": "97b1a516-2bc1-49d5-9d32-b37de38aed35",
      "name": "Prep for Master",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        336,
        240
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent?key=AIzaSyBqXRPKYFBFxNDPjOXbMjgz3Ndh85u41UY",
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {
          "timeout": 600000
        }
      },
      "id": "303da4d0-159c-461a-aba9-59bae5e3f4f9",
      "name": "4. The Master (NanoBanana Pro)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        544,
        240
      ],
      "retryOnFail": true,
      "maxTries": 5,
      "waitBetweenTries": 5000
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ \n  (() => {\n    try {\n      // 1. êµ¬ê¸€ì˜ ì‘ë‹µ(ì´ë¯¸ì§€) ê°€ì ¸ì˜¤ê¸°\n      const candidate = $json.candidates?.[0];\n      const part = candidate?.content?.parts?.[0];\n      \n      // 2. ìì¬ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ ì‚¬ìš© -> ì—ëŸ¬ ë°©ì§€)\n      let matName = \"Phomistone Material\";\n      try {\n        // ì´ë¦„ì´ 'The Formatter'ì¼ ìˆ˜ë„, 'Prep for Master'ì¼ ìˆ˜ë„ ìˆìŒ\n        if ($('The Formatter')) matName = $('The Formatter').item.json.materialName;\n        else if ($('Prep for Master')) matName = $('Prep for Master').item.json.materialName;\n      } catch (e) {\n        // ì´ë¦„ ëª» ì°¾ìœ¼ë©´ ê·¸ëƒ¥ ê¸°ë³¸ê°’ ì”€\n      }\n\n      // 3. ì„±ê³µ: ì´ë¯¸ì§€ê°€ ìˆëŠ” ê²½ìš°\n      if (part?.inlineData?.data) {\n        return JSON.stringify({\n          success: true,\n          result_image_url: \"data:image/jpeg;base64,\" + part.inlineData.data,\n          material_name: matName\n        });\n      } \n      // 3-1. ì„±ê³µ (ë‹¤ë¥¸ ë³€ìˆ˜ëª… ëŒ€ì‘): snake_caseë¡œ ì˜¨ ê²½ìš°\n      else if (part?.inline_data?.data) {\n        return JSON.stringify({\n          success: true,\n          result_image_url: \"data:image/jpeg;base64,\" + part.inline_data.data,\n          material_name: matName\n        });\n      }\n      \n      // 4. ì‹¤íŒ¨: í…ìŠ¤íŠ¸ë§Œ ì˜¨ ê²½ìš°\n      return JSON.stringify({\n        success: false,\n        error: \"Model Response Text: \" + (part?.text || \"No content\"),\n        full_response: $json\n      });\n\n    } catch (e) {\n      return JSON.stringify({ success: false, error: \"Final Parsing Error: \" + e.message });\n    }\n  })()\n}}",
        "options": {}
      },
      "id": "220e6f21-4d3d-48b8-b1d2-4af30591a98b",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        736,
        240
      ]
    },
    {
      "parameters": {
        "jsCode": "// 1. Webhookì—ì„œ ì§ì ‘ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸° (ì´ë¦„ ì˜¤ë¥˜ ë°©ì§€)\nconst webhookData = $('Webhook').item.json.body;\nconst cleanImage = webhookData.image_base64.replace(/^data:image\\/\\w+;base64,/, \"\");\n\n// 2. n8n ì „ìš© 'ë°”ì´ë„ˆë¦¬ íŒŒì¼' ë§Œë“¤ê¸°\nreturn [{\n  json: {},\n  binary: {\n    data: {\n      data: cleanImage,\n      mimeType: 'image/jpeg',\n      fileName: 'upload.jpg'\n    }\n  }\n}];"
      },
      "id": "9da3d565-2070-4606-8cec-29681a342bd5",
      "name": "Make Binary File",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -64,
        240
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/upload/v1beta/files?uploadType=media&key=AIzaSyBqXRPKYFBFxNDPjOXbMjgz3Ndh85u41UY",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "image/jpeg"
            }
          ]
        },
        "sendBody": true,
        "contentType": "binaryData",
        "inputDataFieldName": "data",
        "options": {}
      },
      "id": "f298b6a5-6bfd-4eaa-a9c6-c9fd6b799f23",
      "name": "3. Google File Uploader",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        144,
        240
      ]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Get Material from MCP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Material from MCP": {
      "main": [
        [
          {
            "node": "Prep for Brain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep for Brain": {
      "main": [
        [
          {
            "node": "1. The Brain (Analysis)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1. The Brain (Analysis)": {
      "main": [
        [
          {
            "node": "Prep for Prompter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep for Prompter": {
      "main": [
        [
          {
            "node": "2. The Prompter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "2. The Prompter": {
      "main": [
        [
          {
            "node": "Make Binary File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep for Master": {
      "main": [
        [
          {
            "node": "4. The Master (NanoBanana Pro)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "4. The Master (NanoBanana Pro)": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Make Binary File": {
      "main": [
        [
          {
            "node": "3. Google File Uploader",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3. Google File Uploader": {
      "main": [
        [
          {
            "node": "Prep for Master",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "instanceId": "9c46e96a26be114faa00aba91a37ad455fb0879f25e4c80e7358755c84a78cc4"
  }
}